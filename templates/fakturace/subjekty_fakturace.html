{% extends "base.html" %}

{% block title %}Subjekty fakturace - {{ stredisko.nazev_strediska }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-custom">
        <li class="breadcrumb-item">
            <a href="{{ url_for('strediska.strediska') }}">
                <i class="bi bi-house-door me-1"></i>
                Střediska
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('strediska.spravovat_stredisko', stredisko_id=stredisko.id) }}">
                {{ stredisko.nazev_strediska }}
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('fakturace.fakturace', stredisko_id=stredisko.id) }}">
                Fakturace
            </a>
        </li>
        <li class="breadcrumb-item active">Subjekty fakturace</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-1">
                    <i class="bi bi-people icon-warning me-2"></i>
                    Subjekty fakturace
                </h1>
                <p class="text-muted mb-0">Správa údajů dodavatele, odběratele a vystavovatele pro {{ stredisko.nazev_strediska }}</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('fakturace.fakturace', stredisko_id=stredisko.id) }}" 
                   class="btn btn-outline-primary-custom">
                    <i class="bi bi-arrow-left me-2"></i>
                    Zpět na fakturaci
                </a>
            </div>
        </div>

        <!-- Info Notice -->
        <div class="alert alert-custom mb-4" style="background-color: #f0f9ff; border-left-color: #0ea5e9; color: #0c4a6e;">
            <div class="d-flex align-items-start">
                <i class="bi bi-info-circle-fill me-3 mt-1 flex-shrink-0" style="color: #0ea5e9;"></i>
                <div>
                    <h6 class="mb-2">Inline úpravy</h6>
                    <p class="mb-0 small">
                        Klikněte na libovolnou hodnotu pro její úpravu. Změny se ukládají automaticky po potvrzení.
                        Všechny údaje se použijí při generování PDF faktur.
                    </p>
                </div>
            </div>
        </div>

        <!-- Dodavatel Section -->
        <div class="card-custom mb-4">
            <div class="card-header-custom">
                <h5 class="card-title">
                    <i class="bi bi-building icon-primary me-2"></i>
                    Informace o dodavateli
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <!-- Základní údaje -->
                    <div class="col-md-6 mb-4">
                        <h6 class="text-secondary mb-3">
                            <i class="bi bi-card-text me-2"></i>
                            Základní údaje
                        </h6>
                        
                        <div class="field-row mb-3">
                            <label class="form-label-custom">
                                <i class="bi bi-building me-2"></i>
                                Název společnosti
                            </label>
                            <div class="field-value">
                                <a href="#" class="editable" 
                                   data-name="nazev_sro" 
                                   data-value="{{ dodavatel.nazev_sro if dodavatel else '' }}" 
                                   data-pk="dodavatel"
                                   data-url="{{ url_for('fakturace.upravit_dodavatele', stredisko_id=stredisko.id) }}">
                                   {{ dodavatel.nazev_sro if dodavatel else 'Klikněte pro úpravu' }}
                                </a>
                            </div>
                        </div>
                        
                        <div class="field-row mb-3">
                            <label class="form-label-custom">
                                <i class="bi bi-geo-alt me-2"></i>
                                Adresa - 1. řádek
                            </label>
                            <div class="field-value">
                                <a href="#" class="editable" 
                                   data-name="adresa_radek_1" 
                                   data-value="{{ dodavatel.adresa_radek_1 if dodavatel else '' }}" 
                                   data-pk="dodavatel"
                                   data-url="{{ url_for('fakturace.upravit_dodavatele', stredisko_id=stredisko.id) }}">
                                   {{ dodavatel.adresa_radek_1 if dodavatel else 'Klikněte pro úpravu' }}
                                </a>
                            </div>
                        </div>
                        
                        <div class="field-row mb-3">
                            <label class="form-label-custom">
                                <i class="bi bi-geo-alt me-2"></i>
                                Adresa - 2. řádek
                            </label>
                            <div class="field-value">
                                <a href="#" class="editable" 
                                   data-name="adresa_radek_2" 
                                   data-value="{{ dodavatel.adresa_radek_2 if dodavatel else '' }}" 
                                   data-pk="dodavatel"
                                   data-url="{{ url_for('fakturace.upravit_dodavatele', stredisko_id=stredisko.id) }}">
                                   {{ dodavatel.adresa_radek_2 if dodavatel else 'Klikněte pro úpravu' }}
                                </a>
                            </div>
                        </div>
                        
                        <div class="field-row mb-3">
                            <label class="form-label-custom">
                                <i class="bi bi-hash me-2"></i>
                                IČO
                            </label>
                            <div class="field-value">
                                <a href="#" class="editable" 
                                   data-name="ico_sro" 
                                   data-value="{{ dodavatel.ico_sro if dodavatel else '' }}" 
                                   data-pk="dodavatel"
                                   data-url="{{ url_for('fakturace.upravit_dodavatele', stredisko_id=stredisko.id) }}">
                                   {{ dodavatel.ico_sro if dodavatel else 'Klikněte pro úpravu' }}
                                </a>
                            </div>
                        </div>
                        
                        <div class="field-row mb-3">
                            <label class="form-label-custom">
                                <i class="bi bi-hash me-2"></i>
                                DIČ
                            </label>
                            <div class="field-value">
                                <a href="#" class="editable" 
                                   data-name="dic_sro" 
                                   data-value="{{ dodavatel.dic_sro if dodavatel else '' }}" 
                                   data-pk="dodavatel"
                                   data-url="{{ url_for('fakturace.upravit_dodavatele', stredisko_id=stredisko.id) }}">
                                   {{ dodavatel.dic_sro if dodavatel else 'Klikněte pro úpravu' }}
                                </a>
                            </div>
                        </div>
                        
                        <div class="field-row mb-3">
                            <label class="form-label-custom">
                                <i class="bi bi-journal-text me-2"></i>
                                Zápis u soudu
                            </label>
                            <div class="field-value">
                                <a href="#" class="editable" 
                                   data-name="zapis_u_soudu" 
                                   data-value="{{ dodavatel.zapis_u_soudu if dodavatel else '' }}" 
                                   data-pk="dodavatel"
                                   data-url="{{ url_for('fakturace.upravit_dodavatele', stredisko_id=stredisko.id) }}">
                                   {{ dodavatel.zapis_u_soudu if dodavatel else 'Klikněte pro úpravu' }}
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bankovní údaje -->
                    <div class="col-md-6 mb-4">
                        <h6 class="text-secondary mb-3">
                            <i class="bi bi-bank me-2"></i>
                            Bankovní údaje
                        </h6>
                        
                        <div class="field-row mb-3">
                            <label class="form-label-custom">
                                <i class="bi bi-bank me-2"></i>
                                Banka
                            </label>
                            <div class="field-value">
                                <a href="#" class="editable" 
                                   data-name="banka" 
                                   data-value="{{ dodavatel.banka if dodavatel else '' }}" 
                                   data-pk="dodavatel"
                                   data-url="{{ url_for('fakturace.upravit_dodavatele', stredisko_id=stredisko.id) }}">
                                   {{ dodavatel.banka if dodavatel else 'Klikněte pro úpravu' }}
                                </a>
                            </div>
                        </div>
                        
                        <div class="field-row mb-3">
                            <label class="form-label-custom">
                                <i class="bi bi-credit-card me-2"></i>
                                Číslo účtu
                            </label>
                            <div class="field-value">
                                <a href="#" class="editable" 
                                   data-name="cislo_uctu" 
                                   data-value="{{ dodavatel.cislo_uctu if dodavatel else '' }}" 
                                   data-pk="dodavatel"
                                   data-url="{{ url_for('fakturace.upravit_dodavatele', stredisko_id=stredisko.id) }}">
                                   {{ dodavatel.cislo_uctu if dodavatel else 'Klikněte pro úpravu' }}
                                </a>
                            </div>
                        </div>
                        
                        <div class="field-row mb-3">
                            <label class="form-label-custom">
                                <i class="bi bi-globe me-2"></i>
                                SWIFT/BIC
                            </label>
                            <div class="field-value">
                                <a href="#" class="editable" 
                                   data-name="swift" 
                                   data-value="{{ dodavatel.swift if dodavatel else '' }}" 
                                   data-pk="dodavatel"
                                   data-url="{{ url_for('fakturace.upravit_dodavatele', stredisko_id=stredisko.id) }}">
                                   {{ dodavatel.swift if dodavatel else 'Klikněte pro úpravu' }}
                                </a>
                            </div>
                        </div>
                        
                        <div class="field-row mb-3">
                            <label class="form-label-custom">
                                <i class="bi bi-globe me-2"></i>
                                IBAN
                            </label>
                            <div class="field-value">
                                <a href="#" class="editable" 
                                   data-name="iban" 
                                   data-value="{{ dodavatel.iban if dodavatel else '' }}" 
                                   data-pk="dodavatel"
                                   data-url="{{ url_for('fakturace.upravit_dodavatele', stredisko_id=stredisko.id) }}">
                                   {{ dodavatel.iban if dodavatel else 'Klikněte pro úpravu' }}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vystavovatel Section -->
        <div class="card-custom mb-4">
            <div class="card-header-custom">
                <h5 class="card-title">
                    <i class="bi bi-person-badge icon-success me-2"></i>
                    Informace o vystavovateli
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label-custom">
                            <i class="bi bi-person me-2"></i>
                            Jméno a příjmení
                        </label>
                        <div class="field-value">
                            <a href="#" class="editable" 
                               data-name="jmeno_vystavitele" 
                               data-value="{{ vystavovatel.jmeno_vystavitele if vystavovatel else '' }}" 
                               data-pk="vystavovatel"
                               data-url="{{ url_for('fakturace.upravit_vystavovatele', stredisko_id=stredisko.id) }}">
                               {{ vystavovatel.jmeno_vystavitele if vystavovatel else 'Klikněte pro úpravu' }}
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label-custom">
                            <i class="bi bi-telephone me-2"></i>
                            Telefon
                        </label>
                        <div class="field-value">
                            <a href="#" class="editable" 
                               data-name="telefon_vystavitele" 
                               data-value="{{ vystavovatel.telefon_vystavitele if vystavovatel else '' }}" 
                               data-pk="vystavovatel"
                               data-url="{{ url_for('fakturace.upravit_vystavovatele', stredisko_id=stredisko.id) }}">
                               {{ vystavovatel.telefon_vystavitele if vystavovatel else 'Klikněte pro úpravu' }}
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label-custom">
                            <i class="bi bi-envelope me-2"></i>
                            Email
                        </label>
                        <div class="field-value">
                            <a href="#" class="editable" 
                               data-name="email_vystavitele" 
                               data-value="{{ vystavovatel.email_vystavitele if vystavovatel else '' }}" 
                               data-pk="vystavovatel"
                               data-url="{{ url_for('fakturace.upravit_vystavovatele', stredisko_id=stredisko.id) }}">
                               {{ vystavovatel.email_vystavitele if vystavovatel else 'Klikněte pro úpravu' }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Odběratel Section -->
        <div class="card-custom mb-4">
            <div class="card-header-custom">
                <h5 class="card-title">
                    <i class="bi bi-person-check icon-info me-2"></i>
                    Informace o odběrateli
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label-custom">
                            <i class="bi bi-building me-2"></i>
                            Název společnosti
                        </label>
                        <div class="field-value">
                            <a href="#" class="editable" 
                               data-name="nazev_sro" 
                               data-value="{{ odberatel.nazev_sro if odberatel else '' }}" 
                               data-pk="odberatel"
                               data-url="{{ url_for('fakturace.upravit_odberatele', stredisko_id=stredisko.id) }}">
                               {{ odberatel.nazev_sro if odberatel else 'Klikněte pro úpravu' }}
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label-custom">
                            <i class="bi bi-geo-alt me-2"></i>
                            Adresa - 1. řádek
                        </label>
                        <div class="field-value">
                            <a href="#" class="editable" 
                               data-name="adresa_radek_1" 
                               data-value="{{ odberatel.adresa_radek_1 if odberatel else '' }}" 
                               data-pk="odberatel"
                               data-url="{{ url_for('fakturace.upravit_odberatele', stredisko_id=stredisko.id) }}">
                               {{ odberatel.adresa_radek_1 if odberatel else 'Klikněte pro úpravu' }}
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label-custom">
                            <i class="bi bi-geo-alt me-2"></i>
                            Adresa - 2. řádek
                        </label>
                        <div class="field-value">
                            <a href="#" class="editable" 
                               data-name="adresa_radek_2" 
                               data-value="{{ odberatel.adresa_radek_2 if odberatel else '' }}" 
                               data-pk="odberatel"
                               data-url="{{ url_for('fakturace.upravit_odberatele', stredisko_id=stredisko.id) }}">
                               {{ odberatel.adresa_radek_2 if odberatel else 'Klikněte pro úpravu' }}
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label-custom">
                            <i class="bi bi-hash me-2"></i>
                            IČO
                        </label>
                        <div class="field-value">
                            <a href="#" class="editable" 
                               data-name="ico_sro" 
                               data-value="{{ odberatel.ico_sro if odberatel else '' }}" 
                               data-pk="odberatel"
                               data-url="{{ url_for('fakturace.upravit_odberatele', stredisko_id=stredisko.id) }}">
                               {{ odberatel.ico_sro if odberatel else 'Klikněte pro úpravu' }}
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label-custom">
                            <i class="bi bi-hash me-2"></i>
                            DIČ
                        </label>
                        <div class="field-value">
                            <a href="#" class="editable" 
                               data-name="dic_sro" 
                               data-value="{{ odberatel.dic_sro if odberatel else '' }}" 
                               data-pk="odberatel"
                               data-url="{{ url_for('fakturace.upravit_odberatele', stredisko_id=stredisko.id) }}">
                               {{ odberatel.dic_sro if odberatel else 'Klikněte pro úpravu' }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- X-editable CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.1/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet">

<style>
    .icon-info {
        color: #0ea5e9;
    }
    
    .editable {
        color: var(--primary-color);
        cursor: pointer;
        border-bottom: 1px dashed var(--primary-color);
        text-decoration: none;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: inline-block;
        min-width: 200px;
        min-height: 38px;
        line-height: 1.5;
        background-color: #f8fafc;
        border: 1px solid var(--border-color);
    }
    
    .editable:hover {
        background-color: var(--light-bg);
        text-decoration: none;
        color: var(--primary-dark);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .editable:empty:before {
        content: "Klikněte pro úpravu";
        color: var(--text-muted);
        font-style: italic;
    }
    
    .field-value {
        margin-top: 0.5rem;
    }
    
    .field-row {
        margin-bottom: 1rem;
    }
    
    /* X-editable form styling */
    .editable-input input {
        border: 2px solid var(--primary-color) !important;
        border-radius: 6px;
        padding: 0.5rem;
        font-size: 0.875rem;
    }
    
    .editable-buttons {
        margin-top: 0.5rem;
    }
    
    .editable-buttons .btn {
        margin-right: 0.5rem;
        border-radius: 6px;
    }
    
    /* Section headers */
    .text-secondary {
        color: var(--secondary-color) !important;
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.5rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .editable {
            min-width: 100%;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- X-editable JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.1/bootstrap3-editable/js/bootstrap-editable.min.js"></script>

<script>
    $(document).ready(function() {
        // ✅ Konfigurace X-editable
        $.fn.editable.defaults.mode = 'inline';
        $.fn.editable.defaults.emptytext = 'Klikněte pro úpravu';
        
        // ✅ Aktivace editovatelných polí
        $('.editable').editable({
            type: 'text',
            title: 'Upravit hodnotu',
            placeholder: 'Zadejte hodnotu...',
            emptyclass: 'text-muted',
            showbuttons: 'bottom',
            onblur: 'ignore',
            
            // ✅ Success callback
            success: function(response, newValue) {
                try {
                    const result = typeof response === 'string' ? JSON.parse(response) : response;
                    if (result.status === 'success') {
                        showAlert('success', '✅ ' + result.message);
                        return {newValue: newValue};
                    } else {
                        showAlert('danger', '❌ ' + result.message);
                        return result.message;
                    }
                } catch (e) {
                    showAlert('danger', '❌ Chyba při zpracování odpovědi');
                    return 'Chyba při zpracování';
                }
            },
            
            // ✅ Error callback
            error: function(xhr, status, error) {
                const message = xhr.responseJSON?.message || 'Chyba při ukládání';
                showAlert('danger', '❌ ' + message);
                return message;
            }
        });

        // ✅ Funkce pro zobrazení alertů
        function showAlert(type, message) {
            $('.alert').remove();
            
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('.container').prepend(alertHtml);
            
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }
    });
</script>
{% endblock %}